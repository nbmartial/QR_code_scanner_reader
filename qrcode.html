<!DOCTYPE html>
<html>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <head>
	<title>Code Scanner</title>
	<link rel="stylesheet" href="styles/styles.css" />
	<!--<script type="text/javascript" src="./javascripts/instascan.min.js"></script>-->
	<script type="text/javascript" src="instascan/webrtc-adapter.js"></script>
    <script type="text/javascript" src="instascan/instascan.min.js"></script>
  </head>
  <body>
  <center> 
		<div id ="app" class="app">
			<form>
				<fieldset><legend>Camera</legend>
					<div id="preview-container" class="preview-container">
						<video id="preview"></video>
					 </div>
				</fieldset>
				<fieldset><legend>Scanned informations</legend>
					<div id="scan-container" class="scan-container">
						<section class="scans">
							<label for="field6" > 
								<textarea name="field6" class="textarea-field" id="scanned_info" :title="scan.content"></textarea>
							</label>
						</section>
					</div>
				</fieldset>
			</form>
		</div>
		
		

		<script>
			/* function onAffterCaptureScan {
			var text = event.value;
			document.getElementById("scanned_info").innerHTML = text;
			}*/
			
			var self = this;
			self.scanner = new Instascan.Scanner(
				{
					video: document.getElementById('preview')
				}
			);
			scanner.addListener('scan',function(content, image) {
				<!--self.scans.unshift({ date: +(Date.now()), content: content });-->
				<!--alert('Scanning:' + content); window.open(content, "_blank"); -->
				document.getElementById("scanned_info").innerHTML = content;
			});
			/*
			var playvideo = ()=>{

				navigator.mediaDevices.getUserMedia({ video: { width: { ideal: 1280 }, height: { ideal: 720 }, facingMode: { ideal: 'environment' } } }).then((stream)=>{
					//kConsoleLog('======get video========');
					var video = document.getElementById("preview");
					video.srcObject = stream;
					video.onloadedmetadata = ()=>{
						//kConsoleLog('======play video========');
						video.play();
						//kConsoleLog('======played video========');

						//$('#btn-startReadVideo').removeAttr('disabled');
					};
				}).catch((ex)=>{
					//kConsoleLog(ex);
					alert(ex);
					alert("Please make sure the camera is connected and the site is deployed in https: "+(ex.message || ex));
				});
			};
			
			var loopReadVideo = function(){
				if(!isLooping){
					return;
				}
				//kConsoleLog('======= once read =======')
				var timestart = (new Date()).getTime();

				var reader = new dynamsoft.BarcodeReader();
				reader.decodeFileInMemory(document.getElementById("preview")).then(results=>{
					//kConsoleLog('time cost: ' + ((new Date()).getTime() - timestart) + 'ms');
					for(var i=0;i<results.length;++i){
						var result = results[i];
						//kConsoleLog(result.BarcodeText);
						document.getElementById("scanned_info").innerHTML = result.BarcodeText;
					}
					setTimeout(loopReadVideo, 0);
					return reader.deleteInstance();
				}).catch(ex=>{
					//kConsoleError(ex.message || ex);
					setTimeout(loopReadVideo, 0);
					reader.deleteInstance();
				});
			};
			*/
			Instascan.Camera.getCameras().then(cameras =>
			{
				if(cameras.length > 0){
					self.scanner.start(cameras[0]);
				}else {
					console.error("No cameras found");
				}
				<!--if (cameras.length > 0) {-->
				<!--	var selectedCam = cameras[0];-->
				<!--	$.each(cameras, (i, c) => {-->
				<!--		if (c.name.indexOf('back') != -1) {-->
				<!--			selectedCam = c;-->
				<!--			return false;-->
				<!--		}-->
				<!--	});-->
				<!--	scanner.start(selectedCam);-->
				<!--} else {-->
				<!--	console.error('No cameras found.');-->
				<!--}-->
			});
		</Script>
	</center>
  </body>
</html>