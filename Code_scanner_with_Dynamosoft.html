<!DOCTYPE html>
<html>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <head>
	<title>Code Scanner</title>
	<link rel="stylesheet" href="styles/styles.css" />
	<!--<script  src="./javascripts/dbr-6.4.1.3.min.js"></script>-->
	<script  src="dbr-6.4.1.3.min.js"></script>
	<script src="https://code.jquery.com/jquery-3.3.1.slim.min.js"></script>

    <!-- https://github.com/webrtc/adapter -->
    <script src="https://demo.dynamsoft.com/dbr_wasm/js/webrtc-adapter.js"></script>
	
  </head>
  <body>
  <center> 
		<div id ="app" class="app">
			<form>
				<div id="divLoadInfo">loading...</div>
				<input id="uploadImage" type="file" accept="image/bmp,image/jpeg,image/png,image/gif">
				
				<fieldset><legend>Camera</legend>
					<div id="preview-container" class="preview-container">
						<video id="preview" playsinline="true"></video>
					 </div>
				</fieldset>
				<fieldset><legend>Scanned informations</legend>
					<div id="scan-container" class="scan-container">
						<section class="scans">
							<label for="field6" > 
								<textarea name="field6" class="textarea-field" id="scanned_info" :title="scan.content"></textarea>
							</label>
						</section>
					</div>
				</fieldset>
			</form>
		</div>
		

		<!--
		<script>
			document.getElementById('uploadImage').addEventListener('change', function(){
				var file = this.files[0];
				//blob to image
				var objUrl = URL.createObjectURL(file);
				var image = new Image();
				image.src = objUrl;
				image.onload = function(){//draw image to canvas
					var cvs = document.createElement('canvas');
					cvs.width = image.naturalWidth;
					cvs.height = image.naturalHeight;
					var ctx = cvs.getContext('2d');
					ctx.drawImage(image, 0, 0);
					URL.revokeObjectURL(objUrl);
					//get Uint8ClampedArray from canvas
					var data = ctx.getImageData(0,0,cvs.width,cvs.height).data;
					//decodeBuffer(source, width, height, stride, enumImagePixelFormat)
					var reader = new dynamsoft.BarcodeReader();
					reader.decodeBuffer(data, cvs.width, cvs.height, cvs.width * 4,
					dynamsoft.BarcodeReader.EnumImagePixelFormat.IPF_ARGB_8888
					).then(results=>{
						var txts = [];
						for(let j=0;j<results.length;++j){
							txts.push(results[j].BarcodeText);
						} document.getElementById("scanned_info").innerHTML = txts.join("\n");
					}).catch(ex=>{
						alert('decode fail: ' + (ex.message || ex));
						throw ex;
					});
				};
				image.onerror = function(){
					alert("Can't convert the blob to image.");
				};
				this.value = '';
			});
		</script> -->
		
		<script>
			// By default, js will load `dbr-<version>.min.js` & `dbr-<version>.wasm` in the same folder as the context.
			// `dbr-<version>.min.js` & `dbr-<version>.wasm` should always put in same folder.
			// Modify this setting when you put `dbr-<version>.min.js` & `dbr-<version>.wasm` somewhere else.
			/*
			dynamsoft.dbrEnv.resourcesPath = 'https://demo.dynamsoft.com/dbr_wasm/js';

			//https://www.dynamsoft.com/CustomerPortal/Portal/TrialLicense.aspx
			dynamsoft.dbrEnv.licenseKey = "t0068NQAAAFe3OwXuX/n0PnY7TBXPEBQVZazBLrftAkj/3TU2rimDoLiYuAqmNAj0o7oH1otTITXVAJ3Nv2vLdsI2R9WrAHQ=";
			
			dynamsoft.dbrEnv.bUseWorker = true; //uncomment it to use worker
			
			dynamsoft.dbrEnv.onAutoLoadWasmSuccess = function(){
				playvideo();
				document.getElementById('divLoadInfo').innerHTML= 'load dbr worker success';
				isLooping = true;
				loopReadVideo();
			};
			dynamsoft.dbrEnv.onAutoLoadWasmError = function(ex){
				//kConsoleLog(ex);
				$('#divLoading').text('load dbr worker fail: '+(ex.message || ex));
			};*/
			
			//https://www.dynamsoft.com/CustomerPortal/Portal/TrialLicense.aspx
			dynamsoft.dbrEnv.licenseKey = "t0068NQAAAFe3OwXuX/n0PnY7TBXPEBQVZazBLrftAkj/3TU2rimDoLiYuAqmNAj0o7oH1otTITXVAJ3Nv2vLdsI2R9WrAHQ=";
			dynamsoft = self.dynamsoft || {};
			dynamsoft.dbrEnv = dynamsoft.dbrEnv || {};
			dynamsoft.dbrEnv.onAutoLoadWasmSuccess = function(){
				document.getElementById('divLoadInfo').innerHTML="load dbr wasm success.";
				playvideo();
				isLooping = true;
				loopReadVideo();
			};
			dynamsoft.dbrEnv.onAutoLoadWasmError = function(status){
				document.getElementById('divLoadInfo').innerHTML="load wasm failed: "+status;
			};
			
			var playvideo = ()=>{

				navigator.mediaDevices.getUserMedia({ video: { width: { ideal: 1280 }, height: { ideal: 720 }, facingMode: { ideal: 'environment' } } }).then((stream)=>{
					//kConsoleLog('======get video========');
					var video = document.getElementById("preview");
					video.srcObject = stream;
					video.onloadedmetadata = ()=>{
						//kConsoleLog('======play video========');
						video.play();
						//kConsoleLog('======played video========');

						//$('#btn-startReadVideo').removeAttr('disabled');
					};
				}).catch((ex)=>{
					//kConsoleLog(ex);
					alert(ex);
					alert("Please make sure the camera is connected and the site is deployed in https: "+(ex.message || ex));
				});
			};
			
			//$('#btn-startReadVideo').click(()=>{
				//$('#divReading').show();
				//$('#btn-startReadVideo').hide();
				//$('#btn-stopReadVideo').show();
				//isLooping = true;
				//$('#kConsoleShowHideBtn').click();
				//loopReadVideo();
			//});
			/*$('#btn-stopReadVideo').click(()=>{
				$('#btn-stopReadVideo').hide();
				$('#btn-startReadVideo').show();
				isLooping = false;
				$('#divReading').hide();
			});*/

			//var isLooping = false;
			
			var loopReadVideo = function(){
				if(!isLooping){
					return;
				}
				//kConsoleLog('======= once read =======')
				var timestart = (new Date()).getTime();

				var reader = new dynamsoft.BarcodeReader();
				reader.decodeFileInMemory(document.getElementById("preview")).then(results=>{
					//kConsoleLog('time cost: ' + ((new Date()).getTime() - timestart) + 'ms');
					for(var i=0;i<results.length;++i){
						var result = results[i];
						//kConsoleLog(result.BarcodeText);
						document.getElementById("scanned_info").innerHTML = result.BarcodeText;
					}
					setTimeout(loopReadVideo, 0);
					return reader.deleteInstance();
				}).catch(ex=>{
					//kConsoleError(ex.message || ex);
					setTimeout(loopReadVideo, 0);
					reader.deleteInstance();
				});
			};
			
		</script>
	</center>
  </body>
</html>